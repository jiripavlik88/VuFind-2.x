(function(){angular.module("favorites",[])})();(function(){angular.module("favorites").filter("translate",function(){return function(b){return"translate"in VuFind?VuFind.translate(b):b}})})();(function(){function b(a){var c=!1,b="undefined"!==typeof __notif;return{favAdded:function(){if(!0===b&&!1===c){c=!0;var n=a("you_have_unsaved_favorites");__notif.addNotification(n,"favs")}},allFavsRemoved:function(){!0===b&&(__notif.helper.pointers.global.children(".notif-favs").remove(),0===__notif.sourcesRead.unreadCount&&(c=!1,__notif.warning.hide(),__notif.helper.pointers.global.children().first().show()))}}}angular.module("favorites").factory("favsNotifications",b);b.$inject=["translateFilter"]})();(function(){angular.module("favorites").value("Favorite",function(){var b={title:{link:void 0,value:void 0},author:{link:void 0,value:void 0},published:void 0,format:{iconClass:void 0,value:void 0},image:void 0,icon:{value:void 0,style:void 0},created:(new Date).getTime()},a=this;a.parseCurrentRecord=function(){var c=$("table[summary]"),b=c.find("tbody tr td[property=author] a");0===b.length&&(b=c.find("tbody tr td[property=creator] a"),0===b.length&&(b=c.find("tbody tr td span[property=contributor] a")));
var n=c.find("tbody tr td div.iconlabel");a.titleLink(location.pathname);a.title(function(){var a=c.siblings("h3");if(a.length)return a.text();console.error("Parsing record title failed!")}());a.authorLink(function(){var a=b.prop("href");if("string"===typeof a)return a;console.error("Parsing author's link failed!")}());a.author(function(){var a=b.text();if("string"===typeof a)return a;console.error("Parsing author's name failed!")}());a.formatIconClass(function(){var a=n.children("i");if(a.length)return a.attr("class");
console.error("Parsing format icon class failed!")}());a.format(function(){var a=n.children("span");if(a.length)return a.attr("data-orig");console.error("Parsing record format failed!")}());a.published(function(){var a=c.find("tbody tr td span[property=publicationDate]");if(a.length)return a.text();console.error("Parsing publication year failed!")}());a.image(function(){var b=c.parent().siblings("div.col-sm-3");if(b.length){var e=b.find("img");if(e.length)return e.attr("src");b=b.find("i[class][style]");
b.length?(a.icon(b.attr("class")),a.iconStyle(b.attr("style"))):console.error("Parsing record image source or icon failed!")}else console.error("Parsing record image's parent division failed!")}());return a};a.fromObject=function(c){"object"!==typeof c?console.error("Trying to create Favorite from object, but no object passed"):c.hasOwnProperty("created")?b=c:console.error("Missing timestamp of the object!");return a};a.toObject=function(){return b};a.toString=function(){return JSON.stringify(b)};
a.titleLink=function(c){if("undefined"===typeof c)return b.title.link;b.title.link=c;return a};a.title=function(c){if("undefined"===typeof c)return b.title.value;b.title.value=c;return a};a.authorLink=function(c){if("undefined"===typeof c)return b.author.link;b.author.link=c;return a};a.author=function(c){if("undefined"===typeof c)return b.author.value;b.author.value=c;return a};a.published=function(c){if("undefined"===typeof c)return b.published;b.published=c;return a};a.formatIconClass=function(c){if("undefined"===
typeof c)return b.format.iconClass;b.format.iconClass=c;return a};a.format=function(c){if("undefined"===typeof c)return b.format.value;b.format.value=c;return a};a.image=function(c){if("undefined"===typeof c)return b.image;b.image=c;return a};a.icon=function(c){if("undefined"===typeof c)return b.icon.value;b.icon.value=c;return a};a.iconStyle=function(c){if("undefined"===typeof c)return b.icon.style;b.icon.style=c;return a};a.created=function(){return b.created}})})();(function(){function b(a,c){var b=this;b.create=function(){return new c};b.createFromCurrentRecord=function(){return b.create().parseCurrentRecord()};return b}angular.module("favorites").factory("favoritesFactory",b);b.$inject=["$log","Favorite"]})();(function(){function b(a,b,e){function n(a){return new Promise(function(b,c){k.push(a.toObject());f().then(b)["catch"](c)})}function f(){return new Promise(function(a,b){setTimeout(function(){var b=void 0;k.length?b=sessionStorage.setItem(p.name,JSON.stringify(k)):sessionStorage.removeItem(p.name);a(b)},0)})}function g(a){"function"===typeof a&&(l.done?a.call():l.buffer.push(a))}var p={addFavorite:function(a){return new Promise(function(d,m){a instanceof b?(g(function(){n(a).then(d)["catch"](m)}),
e.favAdded()):m("storage.addFavorite(favorite) needs favorite instanceof Favorite !")})},removeFavorite:function(a){return new Promise(function(b,c){"number"!==typeof a?c("Invalid ID provided"):g(function(){for(var g=k.length,t=[],h=!1,u=0;u<g;++u)k[u].created===a?h=!0:t.push(k[u]);!1===h?c("Invalid ID provided"):(k=t,f().then(b)["catch"](c),0===k.length&&e.allFavsRemoved())})})},removeAllFavorites:function(){return new Promise(function(a,b){k=[];e.allFavsRemoved();f().then(a)["catch"](b)})},hasFavorite:function(a){return new Promise(function(d,
e){g(function(){var g=new RegExp("/"+a.replace(/\./,"\\."));if(k){var f=k.find(function(a){return!!a.title.link.match(g)});"undefined"===typeof f?e():d((new b).fromObject(f))}else e()})})},getFavorite:function(a){return new Promise(function(d,f){"number"===typeof a&&0<=a?g(function(){var g=favorite[a];e.favAdded();d((new b).fromObject(g))}):f("Cannot get favorite without an index")})},getFavorites:function(){return new Promise(function(a,d){g(function(){a(k.map(function(a){e.favAdded();return(new b).fromObject(a)}))})})},
name:"_favs"},k=[],l={done:!1,buffer:[]};(function(){setTimeout(function(){var a=sessionStorage.getItem(p.name);null!==a&&(k=JSON.parse(a));l.done=!0;l.buffer.forEach(function(a){a.call()})},0)})();return p}sessionStorage&&"setItem"in sessionStorage?(angular.module("favorites").factory("storage",b),b.$inject=["$log","Favorite","favsNotifications"]):console.error("This browser does not support sessionStorage, no favorites for not logged user can be provided!")})();(function(){function b(a,b,e,n){function f(b,c){localStorage.setItem(b,c);localStorage.removeItem(b);a.debug("Emitted broadcast with key & value",b,c)}function g(){function a(f){parseInt(f.key)===l&&("null"===f.newValue?sessionStorage.setItem(b.name,"[]"):(window.clearTimeout(g),sessionStorage.setItem(b.name,f.newValue),"function"===typeof window.__favChanged&&(f=JSON.parse(f.newValue),f.map(function(a){return(new e).fromObject(a)}).forEach(function(a){window.__favChanged(!0,a)}),f.length&&n.favAdded()),
window.removeEventListener("storage",a)))}l=Date.now();sessionStorage.tabId=l;window.addEventListener("storage",a);var g=window.setTimeout(function(){window.removeEventListener("storage",a);sessionStorage.setItem(b.name,"[]");k(!0)},1500);f("giveMeFavorites",l)}function p(){l=sessionStorage.tabId;var b=localStorage.favoritesMasterTab;b===l||"rand"===b?k(!0):a.debug("Being a slaveTab is nice!")}function k(d){function e(a){"giveMeFavorites"==a.key&&a.newValue&&(q=a.newValue,f(a.newValue,sessionStorage.getItem(b.name)))}
"undefined"===typeof d?a.debug("Passively becoming masterTab!"):a.debug("Actively becoming masterTab!");localStorage.setItem("favoritesMasterTab",l);window.onbeforeunload=function(){window.removeEventListener("storage",e);localStorage.setItem("favoritesMasterTab",q?q:"rand")};window.addEventListener("storage",e)}"undefined"===typeof sessionStorage.tabId?g():p();window.addEventListener("storage",function(d){a.debug("Recieved an broadcast: ",d);"favoritesMasterTab"===d.key?parseInt(d.newValue)!==l&&
"rand"!==d.newValue||k():"favAdded"===d.key&&d.newValue?(d=JSON.parse(d.newValue),d=(new e).fromObject(d),b.addFavorite(d),"function"===typeof window.__favChanged&&(a.debug("Calling window.__favChanged with ",d),window.__favChanged(!0,d))):"favRemoved"===d.key&&d.newValue?(d=JSON.parse(d.newValue),d=(new e).fromObject(d),b.removeFavorite(d.created()),"function"===typeof window.__favChanged&&(a.debug("Calling window.__favChanged with ",d),window.__favChanged(!1,d))):"purgeAllTabs"===d.key&&d.newValue&&
b.removeAllFavorites()});(function(){"function"===typeof sendMeFavs&&!0===sendMeFavs()&&b.getFavorites().then(function(d){0!==d.length&&(d={favs:d.map(function(a){return a.toObject()})},a.debug("Pushing favorites on prompt ..",d),$.post("/AJAX/JSON?method=pushFavorites",d).always(function(){f("purgeAllTabs");b.removeAllFavorites();location.reload()}))})})();return{broadcastAdded:function(a){a=a.toObject();f("favAdded",JSON.stringify(a))},broadcastRemoved:function(a){f("favRemoved",a)}};var l,q}angular.module("favorites").factory("favsBroadcaster",
b);b.$inject=["$log","storage","Favorite","favsNotifications"]})();(function(){function b(b,f,g,p,k,l){function q(b){(new Promise(function(c,d){p.removeFavorite(b).then(function(){a[b].remove();delete a[b];--h.listLength;0===Object.keys(a).length&&m();var c=parseInt(b);h.favorites=h.favorites.filter(function(a){if(a.created()!==c)return!0;k.broadcastRemoved(a);return!1})})["catch"](function(a){f.error(a)});c()})).then(g.$applyAsync)}function d(a){(new Promise(function(b,c){!a instanceof l?c():(h.favorites.push(a),r(t),1===h.favorites.length&&(m(),h.listLength=1),
b())})).then(g.$applyAsync)}function m(){c.hidden=!c.hidden;e.hidden=!e.hidden}function r(a){(new Promise(function(b,c){var d=!0;switch(a){case "alphabetical":h.favorites.sort(function(a,b){return a.title()>b.title()});break;case "author":h.favorites.sort(function(a,b){return a.author()>b.author()});break;case "recent":h.favorites.sort(function(a,b){return a.created()<b.created()});break;default:d=!1,f.error("Invalid sorting provided")}d&&(t=a)})).then(g.$applyAsync)}var t="recent",h=this;h.favSelected=
{};h.favorites=[];h.sortVal=function(a){return arguments.length?r(a):t};h.allSelected=!1;h.listStart=1;h.listLength=1;h.selectAll=function(){h.favorites.forEach(function(a){h.favSelected[a.created()]=h.allSelected})};h.removeFavorite=q;h.removeSelected=function(){Object.keys(h.favSelected).forEach(function(a){!0===h.favSelected[a]&&(q(parseInt(a)),delete h.favSelected[a])})};b.resolve(p.getFavorites()).then(function(a){a=a.reverse();h.favorites=a;if(a=a.length)m(),h.listLength=a})["catch"](function(a){f.error(a)});
window.__favChanged=function(b,c){c instanceof l&&(!0===b?d(c):!1===b&&(new Promise(function(b,d){var e=c.created();a[e].remove();delete a[e];--h.listLength;0===Object.keys(a).length&&m();h.favorites=h.favorites.filter(function(a){return a.created()!==c.created()});b()})).then(g.$applyAsync))}}angular.module("favorites").controller("ListController",b).directive("favoritesListItem",function(){return{restrict:"A",templateUrl:"/themes/cpk-devel/js/favorites/list-item.html",link:function(b,c,e){a[b.fav.created()]=
c.context}}}).directive("listNotEmpty",function(){return{restrict:"A",link:function(a,b,g){"true"===g.listNotEmpty?(e=b.context,e.hidden=!0):"false"===g.listNotEmpty&&(c=b.context,c.hidden=!1)}}});b.$inject="$q $log $scope storage favsBroadcaster Favorite".split(" ");var a={},c=void 0,e=void 0})();(function(){function b(b,e,n,f,g){function p(){m=n.createFromCurrentRecord();e.addFavorite(m).then(function(){d();g.broadcastAdded(m)})["catch"](function(a){b.error(a)})}function k(){var a=m.created();e.removeFavorite(a).then(function(){d();g.broadcastRemoved(m)})["catch"](function(a){b.error(a)})}function l(){return new Promise(function(a,b){var c=q();e.hasFavorite(c).then(function(b){a(b)})["catch"](b)})}function q(a){return("undefined"===typeof a?location.pathname:a).split("/")[2]}function d(){a.remFavBtn.hidden=
!a.remFavBtn.hidden;a.addFavBtn.hidden=!a.addFavBtn.hidden;r=!r}var m=void 0,r=!1;this.addOrRemoveFavorite=function(){r?k():p()};this.isFavorite=l;l().then(function(a){m=a;d()});window.__favChanged=function(a,b){b instanceof f&&(!0===a?!1===r&&q(b.titleLink())===q()&&(m=b,d()):!1===a&&!0===r&&b.created()===m.created()&&(m=b,d()))}}angular.module("favorites").controller("RecordFavController",b).directive("addRemove",function(){return{restrict:"A",link:function(b,e,n){"add"===e.context.getAttribute("add-remove")?
(a.addFavBtn=e.context,e.context.hidden=!1):"rem"===e.context.getAttribute("add-remove")&&(a.remFavBtn=e.context,e.context.hidden=!0)}}});b.$inject=["$log","storage","favoritesFactory","Favorite","favsBroadcaster"];var a={remFavBtn:void 0,addFavBtn:void 0}})();(function(){angular.module("federativeLogin",[])})();(function(){function b(a){this.login=function(b){if((new URL(b)).host!==location.host)return a.error("You are probably facing an Man-in-the-middle attack ! Please report this issue to portal administrator");var f=document.createElement("iframe");f.src=b;f.id="overl";f.onload=function(){var a=document.createElement("div");a.id="closer";a.innerHTML="&times;";a.onclick=function(){overl.remove();a.remove()};document.body.appendChild(a)};c.appendChild(f)};return this}function a(a){return{restrict:"A",
link:function(b,f,g){switch(g.ngLogin){case "modal":c=f.context;break;default:a.error("Linker for login controller failed linking")}}}}angular.module("federativeLogin").controller("LoginController",b).directive("ngLogin",a);b.$inject=["$log"];a.$inject=["$log"];var c=void 0})();(function(){angular.module("notifications",[])})();(function(){function b(b,e,n){function f(a){return new Promise(function(b,c){n.post("/AJAX/JSON?method=getMyNotifications",$.param({cat_username:a}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(a){a=a.data.data;"object"===typeof a.errors&&a.errors.forEach(function(a){e.error(a)});"undefined"!==typeof a.notifications?b(a.notifications):c("No notifications returned!")},function(a){c(a)})})}var g=this;g.notifications={};g.initNotifications=function(p){g.notifications[p]=
[];b.resolve(f(p)).then(function(b){b instanceof Array&&(g.notifications[p]=b,a.loader.setAttribute("hidden","hidden"),0===a.synchronousNotifications.children.length&&a.withoutNotifications.removeAttribute("hidden"))})["catch"](function(a){e.error(a)})};g.notifClicked=function(a){if("undefined"!==typeof a){var b={notificationType:a.split("/").pop()};n.post("/AJAX/JSON?method=notificationRead",$.param(b),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(){window.location=
a})}};return g}angular.module("notifications").controller("NotificationsController",b).directive("globalNotif",function(){return{restrict:"A",link:function(b,e,n){switch(n.globalNotif){case "loader":a.loader=e.context;break;case "withoutNotifications":a.withoutNotifications=e.context;break;case "synchronousNotifications":a.synchronousNotifications=e.context;break;default:console.error("Linker for notifications controller failed to link global notifications element")}}}});b.$inject=["$q","$log","$http"];
var a={loader:void 0,withoutNotifications:void 0,synchronousNotifications:void 0}})();(function(){function b(a){return this}angular.module("cpk",["favorites","notifications","federativeLogin"]).controller("MainController",b);b.$inject=["favsBroadcaster"]})();
